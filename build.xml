<?xml version="1.0"?>
<project name="toolkit" default="all">
	<property name="src" value="src"/>
	<property name="lib" value="libraries"/>
	<property name="build_root" value="ant_build"/>
	<property name="toolkit_jar" value="${lib}/toolkit.jar"/>
	<property name="package_dir" value="com/trollworks/toolkit"/>
	<property name="toolkit_build" value="${build_root}/toolkit"/>
	<property name="annotation_src" value="com/trollworks/toolkit/annotation"/>
	<property name="generated_src" value="${build_root}/annotations"/>
	<property name="ap_jar" value="${lib}/toolkit_annotation_processors.jar"/>
	<property name="ap_build" value="${build_root}/annotation_processors"/>
	<property name="min_jdk" value="1.8"/>
	<tstamp>
		<format property="version" pattern="4.0.0.yyyyMMddHHmmss"/>
	</tstamp>
	<tstamp>
		<format property="year" pattern="yyyy"/>
	</tstamp>

	<target name="all" description="Builds the annotation processors and the toolkit"
		depends="annotations,toolkit"/>

	<target name="clean" description="Clean up after a build" depends="clean_toolkit,clean_annotations">
		<delete dir="${build_root}"/>
	</target>

	<target name="clean_toolkit" description="Clean up after a toolkit build">
		<delete dir="${toolkit_build}"/>
		<delete dir="${generated_src}"/>
		<delete file="${toolkit_jar}"/>
	</target>
	
	<target name="toolkit" description="Build the toolkit" depends="clean_toolkit">
		<mkdir dir="${toolkit_build}"/>
		<mkdir dir="${generated_src}"/>

		<!-- Compile the code. -->
		<javac srcdir="${src}" destdir="${toolkit_build}"
			excludes="${annotation_src}/processor/**" debug="no" optimize="yes"
			target="${min_jdk}" source="${min_jdk}" deprecation="true" includeantruntime="no">
			<classpath>
				<pathelement location="${lib}/trove-3.0.3.jar"/>
				<pathelement location="../apple_stubs/apple_stubs.jar"/>
			</classpath>
			<compilerarg value="-Xlint:all"/>
			<compilerarg value="-Xlint:-serial"/>
			<compilerarg value="-processorpath"/>
			<compilerarg value="${ap_jar}"/>
			<compilerarg value="-s"/>
			<compilerarg value="${generated_src}"/>
			<compilerarg value="-implicit:class"/>
		</javac>
		
		<!-- Copy the resources over. -->
		<copy todir="${toolkit_build}">
			<fileset dir="${src}" includes="**/*.properties,**/*.png,**/*.gif"/>
		</copy>

		<!-- Create the jar file. -->
		<jar destfile="${toolkit_jar}" basedir="${toolkit_build}" duplicate="fail">
			<manifest>
				<attribute name="bundle-name" value="Trollworks Toolkit"/>
				<attribute name="bundle-version" value="${version}"/>
				<attribute name="bundle-license" value="Mozilla Public License 2.0"/>
				<attribute name="bundle-copyright-owner" value="Richard A. Wilkes"/>
				<attribute name="bundle-copyright-years" value="1998-${year}"/>
			</manifest>
		</jar>
	</target>

	<target name="clean_annotations" description="Clean up after an annotation processor build">
		<delete dir="${ap_build}"/>
		<delete file="${ap_jar}"/>
	</target>

	<target name="annotations" description="Build the annotation processors" depends="clean_annotations">
		<mkdir dir="${ap_build}"/>

		<!-- Compile the code. -->
		<javac srcdir="${src}" destdir="${ap_build}" includes="${annotation_src}/**"
			debug="no" optimize="yes" target="${min_jdk}" source="${min_jdk}" deprecation="true"
			includeantruntime="no">
			<compilerarg value="-Xlint:all"/>
			<compilerarg value="-Xlint:-serial"/>
		</javac>

		<!-- Create the jar file. -->
		<jar destfile="${ap_jar}" basedir="${ap_build}" duplicate="fail">
			<manifest>
				<attribute name="bundle-name" value="Trollworks Toolkit Annotation Processors"/>
				<attribute name="bundle-version" value="${version}"/>
				<attribute name="bundle-license" value="Mozilla Public License 2.0"/>
				<attribute name="bundle-creator" value="Richard A. Wilkes"/>
				<attribute name="bundle-copyright" value="Â© 1998-${year}"/>
			</manifest>
			<service type="javax.annotation.processing.Processor">
				<provider classname="com.trollworks.toolkit.annotation.processor.localization.Processor"/>
			</service>
		</jar>
	</target>
</project>
